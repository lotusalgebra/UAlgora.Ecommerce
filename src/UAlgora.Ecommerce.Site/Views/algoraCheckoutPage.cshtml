@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Extensions
@using UAlgora.Ecommerce.Core.Interfaces.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@inject ICustomerService CustomerService
@{
    Layout = null; // Checkout has its own minimal layout

    // Check if user is authenticated against the EcommerceCustomer scheme
    UAlgora.Ecommerce.Core.Models.Domain.Customer? currentCustomer = null;
    var isAuthenticated = false;

    // Try to authenticate against the EcommerceCustomer scheme specifically
    var authResult = await Context.AuthenticateAsync("EcommerceCustomer");
    if (authResult.Succeeded && authResult.Principal?.Identity?.IsAuthenticated == true)
    {
        isAuthenticated = true;
        var customerIdClaim = authResult.Principal.FindFirst("CustomerId")?.Value
                              ?? authResult.Principal.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (Guid.TryParse(customerIdClaim, out var customerId))
        {
            currentCustomer = await CustomerService.GetByIdAsync(customerId);
        }
    }

    // Get customer's default addresses if available
    var shippingAddress = currentCustomer?.Addresses?.FirstOrDefault(a => a.IsDefaultShipping)
                          ?? currentCustomer?.Addresses?.FirstOrDefault();
    var billingAddress = currentCustomer?.Addresses?.FirstOrDefault(a => a.IsDefaultBilling)
                         ?? shippingAddress;

    // Header
    var logoText = Model.Value<string>("logoText") ?? "ALGORA";
    var secureBadgeText = Model.Value<string>("secureBadgeText") ?? "Secure Checkout";
    var backToCartText = Model.Value<string>("backToCartText") ?? "Back to Cart";

    // Step names
    var step1Name = Model.Value<string>("step1Name") ?? "Information";
    var step2Name = Model.Value<string>("step2Name") ?? "Shipping";
    var step3Name = Model.Value<string>("step3Name") ?? "Payment";
    var step4Name = Model.Value<string>("step4Name") ?? "Review";

    // Express Checkout
    var expressCheckoutEnabled = Model.Value<bool>("expressCheckoutEnabled", defaultValue: true);
    var expressCheckoutTitle = Model.Value<string>("expressCheckoutTitle") ?? "Express Checkout";
    var applePayEnabled = Model.Value<bool>("applePayEnabled", defaultValue: true);
    var googlePayEnabled = Model.Value<bool>("googlePayEnabled", defaultValue: true);
    var paypalExpressEnabled = Model.Value<bool>("paypalExpressEnabled", defaultValue: true);
    var expressDividerText = Model.Value<string>("expressDividerText") ?? "Or continue below";

    // Contact Form
    var contactSectionTitle = Model.Value<string>("contactSectionTitle") ?? "Contact Information";
    var contactSectionSubtitle = Model.Value<string>("contactSectionSubtitle") ?? "We'll use this email to send you order updates";
    var emailLabel = Model.Value<string>("emailLabel") ?? "Email Address *";
    var firstNameLabel = Model.Value<string>("firstNameLabel") ?? "First Name *";
    var lastNameLabel = Model.Value<string>("lastNameLabel") ?? "Last Name *";
    var phoneLabel = Model.Value<string>("phoneLabel") ?? "Phone Number (for delivery updates)";
    var continueToShippingText = Model.Value<string>("continueToShippingText") ?? "Continue to Shipping";

    // Shipping Form
    var shippingAddressTitle = Model.Value<string>("shippingAddressTitle") ?? "Shipping Address";
    var addressLabel = Model.Value<string>("addressLabel") ?? "Street Address *";
    var apartmentLabel = Model.Value<string>("apartmentLabel") ?? "Apartment, suite, etc. (optional)";
    var cityLabel = Model.Value<string>("cityLabel") ?? "City *";
    var stateLabel = Model.Value<string>("stateLabel") ?? "State *";
    var postalCodeLabel = Model.Value<string>("postalCodeLabel") ?? "ZIP Code *";
    var countryLabel = Model.Value<string>("countryLabel") ?? "Country *";
    var saveAddressLabel = Model.Value<string>("saveAddressLabel") ?? "Save this address for future orders";
    var shippingMethodTitle = Model.Value<string>("shippingMethodTitle") ?? "Choose Shipping Method";
    var shippingNote = Model.Value<string>("shippingNote") ?? "Delivery times are estimated. You'll receive tracking info once your order ships.";
    var continueToPaymentText = Model.Value<string>("continueToPaymentText") ?? "Continue to Payment";

    // Payment Form
    var paymentSectionTitle = Model.Value<string>("paymentSectionTitle") ?? "Payment Method";
    var creditCardEnabled = Model.Value<bool>("creditCardEnabled", defaultValue: true);
    var creditCardLabel = Model.Value<string>("creditCardLabel") ?? "Credit / Debit Card";
    var paypalEnabled = Model.Value<bool>("paypalEnabled", defaultValue: true);
    var cardNumberLabel = Model.Value<string>("cardNumberLabel") ?? "Card Number *";
    var cardNameLabel = Model.Value<string>("cardNameLabel") ?? "Name on Card *";
    var expiryLabel = Model.Value<string>("expiryLabel") ?? "Expiry Date *";
    var cvvLabel = Model.Value<string>("cvvLabel") ?? "Security Code (CVV) *";
    var billingAddressLabel = Model.Value<string>("billingAddressLabel") ?? "Billing address same as shipping";
    var securityNotice = Model.Value<string>("securityNotice") ?? "Your payment is secured with 256-bit SSL encryption";
    var continueToReviewText = Model.Value<string>("continueToReviewText") ?? "Review Order";

    // Review
    var reviewTitle = Model.Value<string>("reviewTitle") ?? "Review Your Order";
    var reviewSubtitle = Model.Value<string>("reviewSubtitle") ?? "Please confirm all details before placing your order";
    var termsUrl = Model.Value<string>("termsUrl") ?? "/terms";
    var privacyUrl = Model.Value<string>("privacyUrl") ?? "/privacy";
    var placeOrderText = Model.Value<string>("placeOrderText") ?? "Place Order";
    var processingText = Model.Value<string>("processingText") ?? "Processing...";

    // Trust Badges
    var trustBadgesEnabled = Model.Value<bool>("trustBadgesEnabled", defaultValue: true);
    var sslBadgeText = Model.Value<string>("sslBadgeText") ?? "SSL Secure";
    var returnsBadgeText = Model.Value<string>("returnsBadgeText") ?? "Easy Returns";
    var shippingBadgeText = Model.Value<string>("shippingBadgeText") ?? "Fast Shipping";

    // SEO
    var metaTitle = Model.Value<string>("metaTitle") ?? "Checkout";
    var metaDescription = Model.Value<string>("metaDescription");

    ViewData["Title"] = metaTitle;
    if (!string.IsNullOrEmpty(metaDescription))
    {
        ViewData["Description"] = metaDescription;
    }
}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@metaTitle</title>
    @if (!string.IsNullOrEmpty(metaDescription))
    {
        <meta name="description" content="@metaDescription" />
    }
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Playfair Display', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc',
                            400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf',
                            800: '#86198f', 900: '#701a75',
                        },
                        'accent': {
                            50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 300: '#fda4af',
                            400: '#fb7185', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c',
                            800: '#9f1239', 900: '#881337',
                        },
                        'fashion-black': '#0f0f0f',
                        'fashion-charcoal': '#1a1a1a',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full">
<div class="min-h-screen bg-gray-50 dark:bg-fashion-charcoal" x-data="checkoutPage()">
    <!-- Minimal Header -->
    <header class="bg-white dark:bg-fashion-black border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="/" class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-accent-500 rounded-full flex items-center justify-center">
                        <span class="text-white font-display text-lg font-bold">A</span>
                    </div>
                    <span class="font-display text-xl font-bold text-fashion-black dark:text-white">@logoText</span>
                </a>

                <!-- Secure Checkout Badge -->
                <div class="hidden sm:flex items-center gap-2 text-gray-500 dark:text-gray-400">
                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-sm font-medium">@secureBadgeText</span>
                </div>

                <!-- Back to Cart -->
                <a href="/cart" class="text-fashion-black dark:text-white hover:text-primary-600 dark:hover:text-primary-400 transition flex items-center gap-2 text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    <span class="hidden sm:inline">@backToCartText</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Progress Stepper -->
    <div class="bg-white dark:bg-fashion-black border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <template x-for="(stepData, index) in steps" :key="index">
                    <div class="flex items-center flex-1" :class="index < 3 ? 'flex-1' : ''">
                        <!-- Step Circle -->
                        <div class="flex flex-col items-center">
                            <div class="relative">
                                <div :class="{
                                    'bg-fashion-black dark:bg-white text-white dark:text-fashion-black': step > index,
                                    'bg-primary-500 text-white ring-4 ring-primary-100 dark:ring-primary-900': step === index,
                                    'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400': step < index
                                }" class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300">
                                    <template x-if="step > index">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </template>
                                    <template x-if="step <= index">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" :d="stepData.icon"/>
                                        </svg>
                                    </template>
                                </div>
                            </div>
                            <span :class="step >= index ? 'text-fashion-black dark:text-white font-medium' : 'text-gray-400 dark:text-gray-500'"
                                  class="mt-2 text-xs uppercase tracking-wider hidden sm:block" x-text="stepData.name"></span>
                        </div>
                        <!-- Connector Line -->
                        <template x-if="index < 3">
                            <div class="flex-1 mx-4">
                                <div class="h-0.5 bg-gray-200 dark:bg-gray-700 relative">
                                    <div :class="step > index ? 'w-full' : 'w-0'"
                                         class="absolute inset-0 bg-fashion-black dark:bg-white transition-all duration-500"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <div class="grid lg:grid-cols-12 gap-8 lg:gap-12">
            <!-- Main Content -->
            <div class="lg:col-span-7">
                <!-- Express Checkout (Step 0 only) -->
                @if (expressCheckoutEnabled)
                {
                <div x-show="step === 0" class="mb-8">
                    <div class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800 p-6">
                        <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4 uppercase tracking-wider">@expressCheckoutTitle</p>
                        <div class="grid grid-cols-3 gap-3">
                            @if (applePayEnabled)
                            {
                            <!-- Apple Pay -->
                            <button class="bg-black text-white py-3.5 flex items-center justify-center gap-2 hover:bg-gray-800 transition">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                                </svg>
                                <span class="font-medium text-sm">Pay</span>
                            </button>
                            }
                            @if (googlePayEnabled)
                            {
                            <!-- Google Pay -->
                            <button class="bg-white border border-gray-300 py-3.5 flex items-center justify-center gap-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span class="font-medium text-sm text-gray-700">Pay</span>
                            </button>
                            }
                            @if (paypalExpressEnabled)
                            {
                            <!-- PayPal Express -->
                            <button class="bg-[#FFC439] py-3.5 flex items-center justify-center gap-2 hover:bg-[#f0b429] transition">
                                <svg class="h-5" viewBox="0 0 101 32" fill="none">
                                    <path fill="#003087" d="M12.237 4.1H5.767c-.44 0-.815.319-.883.751L2.138 22.28c-.052.327.202.622.537.622h3.1c.44 0 .816-.319.884-.751l.738-4.676c.068-.432.444-.751.884-.751h2.037c4.247 0 6.698-2.056 7.34-6.133.289-1.784.012-3.187-.824-4.17-.919-1.079-2.548-1.621-4.598-1.621"/>
                                    <path fill="#003087" d="M13.233 10.471c-.352 2.313-2.12 2.313-3.832 2.313h-.973l.683-4.325c.041-.259.263-.449.527-.449h.446c1.165 0 2.265 0 2.833.664.34.397.443.986.316 1.797"/>
                                    <path fill="#0070BA" d="M55.92 10.369h-3.127c-.297 0-.575.144-.746.388l-4.308 6.343-1.825-6.097c-.114-.379-.46-.634-.857-.634h-3.074c-.371 0-.632.361-.513.713l3.44 10.098-3.237 4.566c-.254.358.009.852.446.852h3.124c.294 0 .57-.142.741-.381l10.39-15.003c.249-.36-.015-.845-.454-.845"/>
                                </svg>
                            </button>
                            }
                        </div>
                        <div class="flex items-center gap-4 mt-6">
                            <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                            <span class="text-xs text-gray-400 uppercase tracking-wider">@expressDividerText</span>
                            <div class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></div>
                        </div>
                    </div>
                </div>
                }

                <!-- Step 1: Information -->
                <div x-show="step === 0" class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="font-display text-2xl font-bold text-fashion-black dark:text-white">@contactSectionTitle</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">@contactSectionSubtitle</p>
                    </div>

                    <!-- Logged-in user notice -->
                    <template x-if="isLoggedIn">
                        <div class="p-4 mx-6 mt-6 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 flex items-start gap-3">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <p class="text-sm font-medium text-green-800 dark:text-green-200">Welcome back!</p>
                                <p class="text-sm text-green-700 dark:text-green-300">Your saved information has been auto-filled. You can edit any field if needed.</p>
                            </div>
                        </div>
                    </template>

                    <div class="p-6 space-y-5">
                        <!-- Email with Floating Label -->
                        <div class="relative">
                            <input type="email" id="email" x-model="info.email" required
                                   class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                   placeholder="Email">
                            <label for="email" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                @emailLabel
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- First Name -->
                            <div class="relative">
                                <input type="text" id="firstName" x-model="info.firstName" required
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                       placeholder="First Name">
                                <label for="firstName" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @firstNameLabel
                                </label>
                            </div>
                            <!-- Last Name -->
                            <div class="relative">
                                <input type="text" id="lastName" x-model="info.lastName" required
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                       placeholder="Last Name">
                                <label for="lastName" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @lastNameLabel
                                </label>
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="relative">
                            <input type="tel" id="phone" x-model="info.phone"
                                   class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                   placeholder="Phone">
                            <label for="phone" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                @phoneLabel
                            </label>
                        </div>
                    </div>

                    <div class="p-6 border-t border-gray-200 dark:border-gray-800">
                        <h2 class="font-display text-2xl font-bold text-fashion-black dark:text-white mb-6">@shippingAddressTitle</h2>

                        <div class="space-y-5">
                            <!-- Address -->
                            <div class="relative">
                                <input type="text" id="address1" x-model="shipping.address1" required
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                       placeholder="Address">
                                <label for="address1" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @addressLabel
                                </label>
                            </div>

                            <!-- Apartment -->
                            <div class="relative">
                                <input type="text" id="address2" x-model="shipping.address2"
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                       placeholder="Apartment">
                                <label for="address2" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @apartmentLabel
                                </label>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- City -->
                                <div class="relative">
                                    <input type="text" id="city" x-model="shipping.city" required
                                           class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                           placeholder="City">
                                    <label for="city" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                        @cityLabel
                                    </label>
                                </div>
                                <!-- State -->
                                <div class="relative">
                                    <select id="state" x-model="shipping.state" required
                                            class="w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition appearance-none">
                                        <option value="">Select state</option>
                                        <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
                                        <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option>
                                        <option value="FL">Florida</option><option value="GA">Georgia</option><option value="IL">Illinois</option>
                                        <option value="NY">New York</option><option value="TX">Texas</option><option value="WA">Washington</option>
                                    </select>
                                    <label class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400">@stateLabel</label>
                                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- ZIP -->
                                <div class="relative">
                                    <input type="text" id="postalCode" x-model="shipping.postalCode" required
                                           class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                           placeholder="ZIP Code">
                                    <label for="postalCode" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                        @postalCodeLabel
                                    </label>
                                </div>
                                <!-- Country -->
                                <div class="relative">
                                    <select id="country" x-model="shipping.country" required
                                            class="w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition appearance-none">
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                    </select>
                                    <label class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400">@countryLabel</label>
                                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Save Address Checkbox -->
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" x-model="saveAddress" class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-fashion-black dark:group-hover:text-white transition">@saveAddressLabel</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-6 border-t border-gray-100 dark:border-gray-800">
                        <button x-on:click="nextStep()" class="w-full bg-fashion-black dark:bg-white text-white dark:text-fashion-black py-4 text-sm uppercase tracking-widest font-medium hover:bg-primary-600 dark:hover:bg-primary-400 hover:text-white transition-colors">
                            @continueToShippingText
                        </button>
                    </div>
                </div>

                <!-- Step 2: Shipping Method -->
                <div x-show="step === 1" x-cloak class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800">
                    <!-- Shipping Info Summary -->
                    <div class="p-6 bg-gray-50 dark:bg-fashion-charcoal border-b border-gray-200 dark:border-gray-800">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Ship to</p>
                                <p class="text-fashion-black dark:text-white font-medium" x-text="`${info.firstName} ${info.lastName}`"></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400" x-text="shipping.address1"></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400" x-text="`${shipping.city}, ${shipping.state} ${shipping.postalCode}`"></p>
                            </div>
                            <button x-on:click="step = 0" class="text-primary-600 dark:text-primary-400 text-sm font-medium hover:underline">Change</button>
                        </div>
                    </div>

                    <div class="p-6">
                        <h2 class="font-display text-2xl font-bold text-fashion-black dark:text-white mb-6">@shippingMethodTitle</h2>

                        <div class="space-y-3">
                            <template x-for="method in shippingMethodsList" :key="method.id">
                                <label class="block p-4 border-2 cursor-pointer transition-all"
                                       :class="selectedShipping === method.id
                                           ? 'border-fashion-black dark:border-white bg-gray-50 dark:bg-fashion-charcoal'
                                           : 'border-gray-200 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-500'">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all"
                                                 :class="selectedShipping === method.id
                                                     ? 'border-fashion-black dark:border-white'
                                                     : 'border-gray-300 dark:border-gray-600'">
                                                <div class="w-2.5 h-2.5 rounded-full bg-fashion-black dark:bg-white transition-opacity"
                                                     :class="selectedShipping === method.id ? 'opacity-100' : 'opacity-0'"></div>
                                            </div>
                                            <input type="radio" name="shipping" :value="method.id" x-model="selectedShipping" class="sr-only">
                                            <div>
                                                <p class="font-medium text-fashion-black dark:text-white" x-text="method.name"></p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="method.estimate"></p>
                                            </div>
                                        </div>
                                        <span class="font-display text-lg font-bold text-fashion-black dark:text-white" x-text="method.cost === 0 ? 'FREE' : '$' + method.cost.toFixed(2)"></span>
                                    </div>
                                </label>
                            </template>
                        </div>

                        <!-- Delivery Note -->
                        <div class="mt-6 p-4 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800">
                            <div class="flex gap-3">
                                <svg class="w-5 h-5 text-primary-600 dark:text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-sm text-primary-800 dark:text-primary-200">@shippingNote</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center">
                        <button x-on:click="prevStep()" class="text-fashion-black dark:text-white hover:text-primary-600 dark:hover:text-primary-400 font-medium flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back
                        </button>
                        <button x-on:click="nextStep()" class="bg-fashion-black dark:bg-white text-white dark:text-fashion-black px-8 py-4 text-sm uppercase tracking-widest font-medium hover:bg-primary-600 dark:hover:bg-primary-400 hover:text-white transition-colors">
                            @continueToPaymentText
                        </button>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div x-show="step === 2" x-cloak class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800">
                    <!-- Info Summary -->
                    <div class="p-6 bg-gray-50 dark:bg-fashion-charcoal border-b border-gray-200 dark:border-gray-800 space-y-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Contact</p>
                                <p class="text-fashion-black dark:text-white" x-text="info.email"></p>
                            </div>
                            <button x-on:click="step = 0" class="text-primary-600 dark:text-primary-400 text-sm font-medium hover:underline">Change</button>
                        </div>
                        <div class="h-px bg-gray-200 dark:bg-gray-700"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Ship to</p>
                                <p class="text-fashion-black dark:text-white" x-text="`${shipping.address1}, ${shipping.city}, ${shipping.state}`"></p>
                            </div>
                            <button x-on:click="step = 0" class="text-primary-600 dark:text-primary-400 text-sm font-medium hover:underline">Change</button>
                        </div>
                        <div class="h-px bg-gray-200 dark:bg-gray-700"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Shipping</p>
                                <p class="text-fashion-black dark:text-white" x-text="getShippingName()"></p>
                            </div>
                            <button x-on:click="step = 1" class="text-primary-600 dark:text-primary-400 text-sm font-medium hover:underline">Change</button>
                        </div>
                    </div>

                    <div class="p-6">
                        <h2 class="font-display text-2xl font-bold text-fashion-black dark:text-white mb-6">@paymentSectionTitle</h2>

                        <!-- Payment Options -->
                        <div class="space-y-3 mb-6">
                            @if (creditCardEnabled)
                            {
                            <label class="block p-4 border-2 cursor-pointer transition-all"
                                   :class="paymentMethod === 'card'
                                       ? 'border-fashion-black dark:border-white bg-gray-50 dark:bg-fashion-charcoal'
                                       : 'border-gray-200 dark:border-gray-700 hover:border-gray-400'">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                             :class="paymentMethod === 'card' ? 'border-fashion-black dark:border-white' : 'border-gray-300 dark:border-gray-600'">
                                            <div class="w-2.5 h-2.5 rounded-full bg-fashion-black dark:bg-white" x-show="paymentMethod === 'card'"></div>
                                        </div>
                                        <input type="radio" name="payment" value="card" x-model="paymentMethod" class="sr-only">
                                        <span class="font-medium text-fashion-black dark:text-white">@creditCardLabel</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <div class="w-10 h-6 bg-gradient-to-br from-blue-600 to-blue-800 rounded flex items-center justify-center">
                                            <span class="text-white text-[8px] font-bold italic">VISA</span>
                                        </div>
                                        <div class="w-10 h-6 bg-gradient-to-br from-red-500 to-orange-500 rounded flex items-center justify-center">
                                            <div class="flex -space-x-1">
                                                <div class="w-3 h-3 rounded-full bg-red-600 opacity-80"></div>
                                                <div class="w-3 h-3 rounded-full bg-yellow-400 opacity-80"></div>
                                            </div>
                                        </div>
                                        <div class="w-10 h-6 bg-blue-900 rounded flex items-center justify-center">
                                            <span class="text-white text-[6px] font-bold">AMEX</span>
                                        </div>
                                    </div>
                                </div>
                            </label>
                            }

                            @if (paypalEnabled)
                            {
                            <label class="block p-4 border-2 cursor-pointer transition-all"
                                   :class="paymentMethod === 'paypal'
                                       ? 'border-fashion-black dark:border-white bg-gray-50 dark:bg-fashion-charcoal'
                                       : 'border-gray-200 dark:border-gray-700 hover:border-gray-400'">
                                <div class="flex items-center gap-4">
                                    <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                         :class="paymentMethod === 'paypal' ? 'border-fashion-black dark:border-white' : 'border-gray-300 dark:border-gray-600'">
                                        <div class="w-2.5 h-2.5 rounded-full bg-fashion-black dark:bg-white" x-show="paymentMethod === 'paypal'"></div>
                                    </div>
                                    <input type="radio" name="payment" value="paypal" x-model="paymentMethod" class="sr-only">
                                    <span class="font-medium text-fashion-black dark:text-white">PayPal</span>
                                    <span class="ml-auto text-[#003087] font-bold text-sm italic">Pay<span class="text-[#0070BA]">Pal</span></span>
                                </div>
                            </label>
                            }
                        </div>

                        <!-- Card Form -->
                        <div x-show="paymentMethod === 'card'" x-collapse class="space-y-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <!-- Card Number -->
                            <div class="relative">
                                <input type="text" id="cardNumber" x-model="card.number" maxlength="19"
                                       x-on:input="formatCardNumber($event)"
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                       placeholder="Card Number">
                                <label for="cardNumber" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @cardNumberLabel
                                </label>
                                <div class="absolute right-4 top-1/2 -translate-y-1/2">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Name on Card -->
                            <div class="relative">
                                <input type="text" id="cardName" x-model="card.name"
                                       class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent uppercase"
                                       placeholder="Name on Card">
                                <label for="cardName" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                    @cardNameLabel
                                </label>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Expiry -->
                                <div class="relative">
                                    <input type="text" id="expiry" x-model="card.expiry" maxlength="5"
                                           x-on:input="formatExpiry($event)"
                                           class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                           placeholder="MM/YY">
                                    <label for="expiry" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                        @expiryLabel
                                    </label>
                                </div>
                                <!-- CVV -->
                                <div class="relative">
                                    <input type="password" id="cvv" x-model="card.cvv" maxlength="4"
                                           class="peer w-full px-4 pt-6 pb-2 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition placeholder-transparent"
                                           placeholder="CVV">
                                    <label for="cvv" class="absolute left-4 top-2 text-xs text-gray-500 dark:text-gray-400 transition-all peer-placeholder-shown:top-4 peer-placeholder-shown:text-base peer-focus:top-2 peer-focus:text-xs peer-focus:text-primary-600">
                                        @cvvLabel
                                    </label>
                                </div>
                            </div>

                            <!-- Billing Address -->
                            <label class="flex items-center gap-3 cursor-pointer group pt-2">
                                <input type="checkbox" x-model="sameAsShipping" class="w-5 h-5 rounded border-gray-300 text-fashion-black focus:ring-fashion-black">
                                <span class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-fashion-black dark:group-hover:text-white transition">@billingAddressLabel</span>
                            </label>
                        </div>

                        <!-- Security Notice -->
                        <div class="mt-6 flex items-center gap-3 text-gray-500 dark:text-gray-400">
                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm">@securityNotice</span>
                        </div>
                    </div>

                    <div class="p-6 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center">
                        <button x-on:click="prevStep()" class="text-fashion-black dark:text-white hover:text-primary-600 dark:hover:text-primary-400 font-medium flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back
                        </button>
                        <button x-on:click="nextStep()" class="bg-fashion-black dark:bg-white text-white dark:text-fashion-black px-8 py-4 text-sm uppercase tracking-widest font-medium hover:bg-primary-600 dark:hover:bg-primary-400 hover:text-white transition-colors">
                            @continueToReviewText
                        </button>
                    </div>
                </div>

                <!-- Step 4: Review -->
                <div x-show="step === 3" x-cloak class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="font-display text-2xl font-bold text-fashion-black dark:text-white">@reviewTitle</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">@reviewSubtitle</p>
                    </div>

                    <!-- Review Cards -->
                    <div class="p-6 grid md:grid-cols-2 gap-4">
                        <!-- Contact -->
                        <div class="p-4 bg-gray-50 dark:bg-fashion-charcoal border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contact</p>
                                <button x-on:click="step = 0" class="text-primary-600 dark:text-primary-400 text-xs font-medium hover:underline">Edit</button>
                            </div>
                            <p class="text-fashion-black dark:text-white font-medium" x-text="info.email"></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" x-text="info.phone || 'No phone provided'"></p>
                        </div>

                        <!-- Shipping Address -->
                        <div class="p-4 bg-gray-50 dark:bg-fashion-charcoal border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ship to</p>
                                <button x-on:click="step = 0" class="text-primary-600 dark:text-primary-400 text-xs font-medium hover:underline">Edit</button>
                            </div>
                            <p class="text-fashion-black dark:text-white font-medium" x-text="`${info.firstName} ${info.lastName}`"></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" x-text="shipping.address1"></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" x-text="`${shipping.city}, ${shipping.state} ${shipping.postalCode}`"></p>
                        </div>

                        <!-- Shipping Method -->
                        <div class="p-4 bg-gray-50 dark:bg-fashion-charcoal border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Shipping Method</p>
                                <button x-on:click="step = 1" class="text-primary-600 dark:text-primary-400 text-xs font-medium hover:underline">Edit</button>
                            </div>
                            <p class="text-fashion-black dark:text-white font-medium" x-text="getShippingName()"></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" x-text="getShippingEstimate()"></p>
                        </div>

                        <!-- Payment -->
                        <div class="p-4 bg-gray-50 dark:bg-fashion-charcoal border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Payment</p>
                                <button x-on:click="step = 2" class="text-primary-600 dark:text-primary-400 text-xs font-medium hover:underline">Edit</button>
                            </div>
                            <template x-if="paymentMethod === 'card'">
                                <div>
                                    <p class="text-fashion-black dark:text-white font-medium">Credit Card</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400" x-text="'•••• •••• •••• ' + card.number.slice(-4)"></p>
                                </div>
                            </template>
                            <template x-if="paymentMethod === 'paypal'">
                                <p class="text-fashion-black dark:text-white font-medium">PayPal</p>
                            </template>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="p-6 border-t border-gray-200 dark:border-gray-800">
                        <h3 class="text-sm uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-4">Order Items (<span x-text="cart.items.length"></span>)</h3>
                        <div class="space-y-4">
                            <template x-for="item in cart.items" :key="item.id">
                                <div class="flex gap-4">
                                    <div class="w-20 h-24 bg-gray-100 dark:bg-fashion-charcoal flex-shrink-0 overflow-hidden">
                                        <img :src="item.image || 'https://placehold.co/80x96/e2e8f0/64748b?text=Product'" :alt="item.name" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-fashion-black dark:text-white truncate" x-text="item.name"></h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="`Size: ${item.size || 'One Size'}`"></p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="`Qty: ${item.quantity}`"></p>
                                    </div>
                                    <p class="font-display text-lg font-bold text-fashion-black dark:text-white" x-text="'$' + (item.price * item.quantity).toFixed(2)"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Terms -->
                    <div class="p-6 border-t border-gray-200 dark:border-gray-800">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input type="checkbox" x-model="acceptTerms" class="w-5 h-5 mt-0.5 rounded border-gray-300 text-fashion-black focus:ring-fashion-black">
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                                I agree to the <a href="@termsUrl" class="text-primary-600 dark:text-primary-400 hover:underline">Terms & Conditions</a> and <a href="@privacyUrl" class="text-primary-600 dark:text-primary-400 hover:underline">Privacy Policy</a>
                            </span>
                        </label>
                    </div>

                    <div class="p-6 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center">
                        <button x-on:click="prevStep()" class="text-fashion-black dark:text-white hover:text-primary-600 dark:hover:text-primary-400 font-medium flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back
                        </button>
                        <button x-on:click="placeOrder()"
                                :disabled="processing || !acceptTerms"
                                class="bg-accent-500 text-white px-8 py-4 text-sm uppercase tracking-widest font-medium hover:bg-accent-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
                            <template x-if="processing">
                                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </template>
                            <template x-if="!processing">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            </template>
                            <span x-text="processing ? '@processingText' : '@placeOrderText $' + orderTotal.toFixed(2)"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="lg:col-span-5">
                <div class="bg-white dark:bg-fashion-black border border-gray-200 dark:border-gray-800 sticky top-8">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="font-display text-xl font-bold text-fashion-black dark:text-white">Order Summary</h2>
                    </div>

                    <!-- Cart Items -->
                    <div class="p-6 max-h-80 overflow-y-auto border-b border-gray-200 dark:border-gray-800">
                        <div class="space-y-4">
                            <template x-for="item in cart.items" :key="item.id">
                                <div class="flex gap-4">
                                    <div class="relative flex-shrink-0">
                                        <div class="w-16 h-20 bg-gray-100 dark:bg-fashion-charcoal overflow-hidden">
                                            <img :src="item.image || 'https://placehold.co/64x80/e2e8f0/64748b?text=P'" :alt="item.name" class="w-full h-full object-cover">
                                        </div>
                                        <span class="absolute -top-2 -right-2 bg-gray-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-medium" x-text="item.quantity"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-fashion-black dark:text-white truncate" x-text="item.name"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="`Size: ${item.size || 'One Size'}`"></p>
                                    </div>
                                    <p class="text-sm font-medium text-fashion-black dark:text-white" x-text="'$' + (item.price * item.quantity).toFixed(2)"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Promo Code -->
                    <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                        <div class="flex gap-2">
                            <input type="text" x-model="promoCode" placeholder="Promo code"
                                   class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-700 bg-transparent text-fashion-black dark:text-white text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <button x-on:click="applyPromo()" class="px-6 py-3 border border-fashion-black dark:border-white text-fashion-black dark:text-white text-sm uppercase tracking-wider font-medium hover:bg-fashion-black hover:text-white dark:hover:bg-white dark:hover:text-fashion-black transition">
                                Apply
                            </button>
                        </div>
                        <template x-if="promoApplied">
                            <div class="mt-2 flex items-center gap-2 text-green-600 dark:text-green-400">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm" x-text="promoMessage"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Totals -->
                    <div class="p-6 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
                            <span class="text-fashion-black dark:text-white" x-text="'$' + cart.subtotal.toFixed(2)"></span>
                        </div>
                        <template x-if="promoDiscount > 0">
                            <div class="flex justify-between text-sm text-green-600 dark:text-green-400">
                                <span>Discount</span>
                                <span x-text="'-$' + promoDiscount.toFixed(2)"></span>
                            </div>
                        </template>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Shipping</span>
                            <span class="text-fashion-black dark:text-white" x-text="shippingCost > 0 ? '$' + shippingCost.toFixed(2) : 'FREE'"></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Estimated Tax</span>
                            <span class="text-fashion-black dark:text-white" x-text="'$' + taxAmount.toFixed(2)"></span>
                        </div>
                    </div>

                    <div class="p-6 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-fashion-charcoal">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-display font-bold text-fashion-black dark:text-white">Total</span>
                            <span class="text-2xl font-display font-bold text-fashion-black dark:text-white" x-text="'$' + orderTotal.toFixed(2)"></span>
                        </div>
                    </div>

                    <!-- Trust Badges -->
                    @if (trustBadgesEnabled)
                    {
                    <div class="p-6 border-t border-gray-200 dark:border-gray-800">
                        <div class="flex items-center justify-center gap-4 text-gray-400 dark:text-gray-500">
                            <div class="flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-xs">@sslBadgeText</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                <span class="text-xs">@returnsBadgeText</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                </svg>
                                <span class="text-xs">@shippingBadgeText</span>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function checkoutPage() {
    // Customer data from server (pre-populated for logged-in users)
    const customerData = @Html.Raw(Json.Serialize(new {
        isAuthenticated = isAuthenticated,
        email = currentCustomer?.Email ?? "",
        firstName = currentCustomer?.FirstName ?? "",
        lastName = currentCustomer?.LastName ?? "",
        phone = currentCustomer?.Phone ?? "",
        shippingAddress = shippingAddress != null ? new {
            address1 = shippingAddress.AddressLine1 ?? "",
            address2 = shippingAddress.AddressLine2 ?? "",
            city = shippingAddress.City ?? "",
            state = shippingAddress.StateProvince ?? "",
            postalCode = shippingAddress.PostalCode ?? "",
            country = shippingAddress.Country ?? "US"
        } : null
    }));

    return {
        step: 0,
        processing: false,
        cart: JSON.parse(localStorage.getItem('cart') || '{"items":[],"subtotal":0}'),
        isLoggedIn: customerData.isAuthenticated,

        // Step names from CMS
        steps: [
            { name: '@step1Name', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
            { name: '@step2Name', icon: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4' },
            { name: '@step3Name', icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z' },
            { name: '@step4Name', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
        ],

        // Pre-populate with customer data if logged in
        info: {
            email: customerData.email || '',
            firstName: customerData.firstName || '',
            lastName: customerData.lastName || '',
            phone: customerData.phone || ''
        },
        shipping: customerData.shippingAddress ? {
            address1: customerData.shippingAddress.address1 || '',
            address2: customerData.shippingAddress.address2 || '',
            city: customerData.shippingAddress.city || '',
            state: customerData.shippingAddress.state || '',
            postalCode: customerData.shippingAddress.postalCode || '',
            country: customerData.shippingAddress.country || 'US'
        } : { address1: '', address2: '', city: '', state: '', postalCode: '', country: 'US' },
        selectedShipping: 'standard',
        saveAddress: false,
        paymentMethod: 'card',
        card: { number: '', name: '', expiry: '', cvv: '' },
        sameAsShipping: true,
        acceptTerms: false,

        promoCode: '',
        promoApplied: false,
        promoMessage: '',
        promoDiscount: 0,

        shippingMethodsList: [
            { id: 'standard', name: 'Standard Shipping', estimate: '5-7 business days', cost: 5.99, freeOver: 50 },
            { id: 'express', name: 'Express Shipping', estimate: '2-3 business days', cost: 12.99 },
            { id: 'overnight', name: 'Overnight Shipping', estimate: 'Next business day', cost: 24.99 }
        ],

        get shippingCost() {
            const method = this.shippingMethodsList.find(m => m.id === this.selectedShipping);
            if (method && method.freeOver && this.cart.subtotal >= method.freeOver) {
                return 0;
            }
            return method ? method.cost : 5.99;
        },

        get taxAmount() {
            return (this.cart.subtotal - this.promoDiscount) * 0.08;
        },

        get orderTotal() {
            return this.cart.subtotal - this.promoDiscount + this.shippingCost + this.taxAmount;
        },

        getShippingName() {
            const method = this.shippingMethodsList.find(m => m.id === this.selectedShipping);
            return method?.name || 'Standard Shipping';
        },

        getShippingEstimate() {
            const method = this.shippingMethodsList.find(m => m.id === this.selectedShipping);
            return method?.estimate || '5-7 business days';
        },

        formatCardNumber(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            this.card.number = formattedValue;
        },

        formatExpiry(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            this.card.expiry = value;
        },

        applyPromo() {
            const code = this.promoCode.toUpperCase();
            if (code === 'SAVE10') {
                this.promoDiscount = this.cart.subtotal * 0.10;
                this.promoApplied = true;
                this.promoMessage = '10% discount applied!';
            } else if (code === 'SAVE20') {
                this.promoDiscount = this.cart.subtotal * 0.20;
                this.promoApplied = true;
                this.promoMessage = '20% discount applied!';
            } else if (code === 'FREESHIP') {
                this.promoApplied = true;
                this.promoMessage = 'Free shipping applied!';
            } else {
                this.promoApplied = false;
                this.promoMessage = '';
                alert('Invalid promo code');
            }
        },

        nextStep() {
            if (this.step === 0 && !this.validateInfo()) return;
            if (this.step === 2 && this.paymentMethod === 'card' && !this.validateCard()) return;
            if (this.step < 3) this.step++;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        prevStep() {
            if (this.step > 0) this.step--;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        validateInfo() {
            if (!this.info.email || !this.info.firstName || !this.info.lastName) {
                alert('Please fill in all contact information fields');
                return false;
            }
            if (!this.shipping.address1 || !this.shipping.city || !this.shipping.state || !this.shipping.postalCode) {
                alert('Please fill in all shipping address fields');
                return false;
            }
            return true;
        },

        validateCard() {
            if (!this.card.number || this.card.number.replace(/\s/g, '').length < 16) {
                alert('Please enter a valid card number');
                return false;
            }
            if (!this.card.name) {
                alert('Please enter the name on the card');
                return false;
            }
            if (!this.card.expiry || this.card.expiry.length < 5) {
                alert('Please enter a valid expiry date');
                return false;
            }
            if (!this.card.cvv || this.card.cvv.length < 3) {
                alert('Please enter a valid CVV');
                return false;
            }
            return true;
        },

        async placeOrder() {
            if (!this.acceptTerms) {
                alert('Please accept the terms and conditions');
                return;
            }

            this.processing = true;

            try {
                // Build cart items for API
                const items = this.cart.items.map(item => ({
                    productId: item.id,
                    quantity: item.quantity
                }));

                // Call the place-order API
                const response = await fetch('/api/ecommerce/checkout/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: this.info.email,
                        firstName: this.info.firstName,
                        lastName: this.info.lastName,
                        phone: this.info.phone,
                        shippingAddress1: this.shipping.address1,
                        shippingAddress2: this.shipping.address2,
                        shippingCity: this.shipping.city,
                        shippingState: this.shipping.state,
                        shippingPostalCode: this.shipping.postalCode,
                        shippingCountry: this.shipping.country,
                        shippingMethod: this.selectedShipping,
                        shippingCost: this.shippingCost,
                        paymentMethod: this.paymentMethod,
                        items: items
                    })
                });

                const result = await response.json();

                if (result.success || result.data?.orderNumber) {
                    const orderNumber = result.data?.orderNumber || result.orderNumber;

                    // Clear cart
                    localStorage.removeItem('cart');

                    // Redirect to confirmation
                    window.location.href = `/order-confirmation/${orderNumber}`;
                } else {
                    alert(result.message || 'Failed to place order. Please try again.');
                    this.processing = false;
                }
            } catch (error) {
                console.error('Order error:', error);
                alert('Failed to place order. Please try again.');
                this.processing = false;
            }
        }
    };
}
</script>
</body>
</html>